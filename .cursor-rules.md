# kimP 프로젝트 AI 규칙 (AI Rules for kimP Project)

## 0. 개요 (Overview)

본 문서는 AI가 `kimP` 프로젝트의 코드 베이스를 분석하고 수정 제안을 할 때 반드시 따라야 할 핵심 규칙과 설계 철학을 정의합니다. 본 규칙을 숙지하고 모든 답변과 코드 생성 시 이 원칙들을 최우선으로 고려해야 합니다.

---

## 1. 프로젝트 핵심 철학 (Core Philosophy)

이 프로젝트는 단순한 암호화폐 가격 비교 봇이 아닙니다. 모든 코드 수정 및 분석 시 아래의 핵심 철학을 반드시 준수해야 합니다.

### 1.1. 목표 (Goal)

자본의 회전율을 극대화하고, 모든 거래 단계에서 발생하는 유형/무형의 비용과 리스크를 정밀하게 관리하여 안정적이고 지속 가능한 차익을 창출하는 것을 목표로 합니다.

### 1.2. 핵심 전략 (Core Strategy)

고프리미엄(HP) 단계에서 충분한 이익을 확보한 뒤, 저프리미엄(LP) 단계에서는 **'추가 수익'이 아닌 '최저 비용 자금 회수'**를 목표로 합니다. 이를 통해 희귀한 역프리미엄 기회에 얽매이지 않고 시장 상황에 맞춰 유연하게 사이클을 완료합니다.

---

## 2. 순손익 계산 규칙 (Rule for Profit Calculation)

> **가장 중요한 규칙입니다.** 순손익 및 수익률에 대한 모든 계산과 분석은 반드시 `fee-calculator.service.ts`의 로직에 근거해야 합니다. 답변 시 아래 4가지 비용 요소를 **절대 누락해서는 안 됩니다.**

1.  **거래 수수료 (Trading Fees)**

    - **설명**: 업비트와 바이낸스에서 코인을 매수/매도할 때 지불하는 기본 비용입니다.
    - **코드 근거**: `estimateFeesForHighPremium` 및 `estimateFeesForLowPremium` 함수 내의 각 거래소 수수료율.

2.  **헷징 수수료 (Hedging Fees)**

    - **설명**: 코인 전송 시간 동안의 가격 변동 리스크를 제거하기 위해 바이낸스 선물 시장에서 숏(매도) 포지션을 개설하고 청산할 때 발생하는 비용입니다. 시스템의 안정성을 위한 필수 비용입니다.
    - **코드 근거**: `fee-calculator.service.ts` 내 `futuresFeeRate` 변수.

3.  **송금 수수료 (Withdrawal Fees)**

    - **설명**: 거래소 간 코인 이동 시 발생하는 **고정 수량**의 출금 수수료입니다. 이 비용은 투자 원금의 크기와 무관하므로, 소액 투자 시 수익률에 큰 영향을 미칩니다.
    - **코드 근거**: `BINANCE_TRANSFER_FEE_TABLE` 및 `UPBIT_TRANSFER_FEE_TABLE` 상수.

4.  **슬리피지 (Slippage)**
    - **설명**: 실시간 호가창의 매물(유동성) 부족으로 인해 원하는 가격보다 불리하게 주문이 체결될 때 발생하는 잠재적 비용입니다.
    - **코드 근거**: `slippage-calculator.service.ts`의 `calculate` 메소드를 통해 계산되며, `spread-calculator.service.ts`에서 최종 수익률에 반영됩니다.

> #### ⚠️ **잘못된 답변 예시:**
>
> "HP 단계 1.78% + LP 단계 -1.1% = 최종 0.68% 수익입니다."
>
> #### ✅ **올바른 답변 예시:**
>
> "HP 단계의 프리미엄 수익(1.78%)에서 모든 비용(거래/헷징/송금 수수료)을 차감한 순이익과, LP 단계의 프리미엄 손실(-1.1%)과 비용을 합산한 순손익을 더하여 최종 결과를 도출해야 합니다."

---

## 3. 저프리미엄(LP) 단계 로직 규칙

**이 규칙을 이해하는 것이 이 프로젝트를 이해하는 핵심입니다.**

### 3.1. "손실 허용의 원칙"

LP 단계는 자금 회수 과정이므로, HP 단계에서 얻은 이익 범위 내라면 **약간의 김치 프리미엄(+)이 있는 코인을 통해 손실을 보면서 자금을 회수하는 것이 정상적이고 의도된 동작**입니다.

### 3.2. '허용 가능한 손실' (`allowedLossKrw`)

LP 단계의 목표는 `allowedLossKrw` (허용 가능한 손실액)을 초과하지 않는 범위 내에서 가장 효율적인(손실이 가장 적은) 코인을 찾는 것입니다. `low-premium-processor.service.ts`가 이 핵심 로직을 담당합니다.

### 3.3. "역프리미엄은 필수가 아닌 보너스"

LP 단계에서 역프리미엄(-) 코인을 찾는 것은 수익을 극대화하는 **최상의 시나리오(Best Case)**일 뿐, 시스템의 **필수 조건(Requirement)**이 아닙니다. 이 유연성이 자본 회전율을 높이는 핵심입니다.

> #### 올바른 분석 예시
>
> "LP 단계에서 +0.6%의 김프가 발생했더라도, HP 단계의 수익(+1.78%)으로 이를 상쇄하고도 최종 목표 수익률(예: 0.5%)을 달성할 수 있다면, 이는 시스템의 기준을 충족하는 성공적인 자금 회수 전략입니다."

---

## 4. 아키텍처 및 코드 수정 가이드라인

### 4.1. 코드 근거 제시

시스템의 동작 방식을 설명할 때는 항상 관련된 특정 소스 파일(예: `low-premium-processor.service.ts`, `strategy-high.service.ts` 등)을 **명시적으로 언급하여 [cite] 형식으로 답변의 신뢰도**를 높여야 합니다.

### 4.2. '섹션' 기반 병렬 처리 모델 (향후 확장 방향)

이 시스템은 향후 **자본을 여러 '섹션'으로 분할하여 HP/LP 단계를 비동기 병렬 처리**하는 방향으로 고도화될 예정입니다. 기능 추가나 리팩토링 시 이 확장성을 항상 염두에 두어야 합니다.

- **독립 상태**: 각 섹션은 독립적인 상태(e.g., `IDLE`, `HP_COMPLETED_WAITING_FOR_LP`)를 가집니다.
- **병렬 실행**: 섹션 1이 HP 완료 후 대기하는 동안, 섹션 2는 새로운 HP 기회를 포착하여 플로우를 시작할 수 있습니다.
- **최적 매칭**: 시스템은 시장의 LP 기회를 포착하여, 대기 중인 여러 섹션 중 해당 LP 기회와 조합했을 때 **가장 수익률이 극대화되는 파트너와 동적으로 매칭**합니다.

### 4.3. 상태 관리 (State Management)

모든 상태 변경은 `ArbitrageCycleStateService`를 통해 중앙에서 관리되어야 합니다. 새로운 로직 추가 시, 상태 머신에 미치는 영향을 반드시 고려하여 예측 가능하고 일관된 흐름을 유지해야 합니다.
